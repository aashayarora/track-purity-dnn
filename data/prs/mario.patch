From c90e64223ae151abca0759388ca305fc129d93cd Mon Sep 17 00:00:00 2001
From: Mario Masciovecchio <mario.masciovecchio@cern.ch>
Date: Wed, 12 Nov 2025 08:40:02 -0800
Subject: [PATCH 1/2] Update mkFit-related processModifier for LST-seeded
 phase-2 HLT single tracking iteration

---
 .../python/HLT_75e33/eventsetup/hltESPMkFit_cfi.py  | 13 ++++++++++++-
 .../modules/hltInitialStepTrackCandidates_cfi.py    |  8 ++++++--
 2 files changed, 18 insertions(+), 3 deletions(-)

diff --git a/HLTrigger/Configuration/python/HLT_75e33/eventsetup/hltESPMkFit_cfi.py b/HLTrigger/Configuration/python/HLT_75e33/eventsetup/hltESPMkFit_cfi.py
index 9249c5ee1b778..4cb85738cb79a 100644
--- a/HLTrigger/Configuration/python/HLT_75e33/eventsetup/hltESPMkFit_cfi.py
+++ b/HLTrigger/Configuration/python/HLT_75e33/eventsetup/hltESPMkFit_cfi.py
@@ -17,5 +17,16 @@ def _addProcesshltInitialStepMkFitConfig(process):
         minPt = cms.double(0.8)
     )
 
+def _addProcesshltLSTStepMkFitConfig(process):
+    process.hltInitialStepTrackCandidatesMkFitConfig = cms.ESProducer("MkFitIterationConfigESProducer",
+        ComponentName = cms.string('hltInitialStepTrackCandidatesMkFitConfig'),
+        appendToDataLabel = cms.string(''),
+        config = cms.FileInPath('RecoTracker/MkFit/data/mkfit-phase2-lstStep.json'),
+        maxClusterSize = cms.uint32(8),
+        minPt = cms.double(0.9)
+    )
+
 from Configuration.ProcessModifiers.hltTrackingMkFitInitialStep_cff import hltTrackingMkFitInitialStep
-modifyConfigurationForTrackingMkFithltInitialStepMkFitConfig_ = hltTrackingMkFitInitialStep.makeProcessModifier(_addProcesshltInitialStepMkFitConfig)
+from Configuration.ProcessModifiers.seedingLST_cff import seedingLST
+modifyConfigurationForTrackingMkFithltInitialStepMkFitConfig_ = (~seedingLST & hltTrackingMkFitInitialStep).makeProcessModifier(_addProcesshltInitialStepMkFitConfig)
+modifyConfigurationForTrackingMkFithltLSTStepMkFitConfig_ = (seedingLST & hltTrackingMkFitInitialStep).makeProcessModifier(_addProcesshltLSTStepMkFitConfig)
diff --git a/HLTrigger/Configuration/python/HLT_75e33/modules/hltInitialStepTrackCandidates_cfi.py b/HLTrigger/Configuration/python/HLT_75e33/modules/hltInitialStepTrackCandidates_cfi.py
index f1f58c4aee220..a1a69270fccf6 100644
--- a/HLTrigger/Configuration/python/HLT_75e33/modules/hltInitialStepTrackCandidates_cfi.py
+++ b/HLTrigger/Configuration/python/HLT_75e33/modules/hltInitialStepTrackCandidates_cfi.py
@@ -72,8 +72,12 @@
     ttrhBuilder = cms.ESInputTag("","WithTrackAngle")
 )
 
-_hltInitialStepTrackCandidatesMkFitLSTSeeds = _hltInitialStepTrackCandidatesMkFit.clone(seeds = "hltInitialStepTrajectorySeedsLST")
-                                                     
+_hltInitialStepTrackCandidatesMkFitLSTSeeds = _hltInitialStepTrackCandidatesMkFit.clone(
+    seeds = "hltInitialStepTrajectorySeedsLST",
+    candMinNHitsCut = 4,
+    candMinPtCut = 0.9
+)
+
 from Configuration.ProcessModifiers.singleIterPatatrack_cff import singleIterPatatrack
 from Configuration.ProcessModifiers.trackingLST_cff import trackingLST
 from Configuration.ProcessModifiers.seedingLST_cff import seedingLST

From 332b8f07ed0f4d3fbbbc28b77f08b51dc8e7eec2 Mon Sep 17 00:00:00 2001
From: Mario Masciovecchio <mario.masciovecchio@cern.ch>
Date: Fri, 14 Nov 2025 05:12:31 -0800
Subject: [PATCH 2/2] Actually use Phase2CAExtension in .7571 workflow

---
 Configuration/PyReleaseValidation/README.md                     | 2 +-
 Configuration/PyReleaseValidation/python/relval_Run4.py         | 2 +-
 .../PyReleaseValidation/python/upgradeWorkflowComponents.py     | 2 +-
 Configuration/PyReleaseValidation/scripts/runTheMatrix.py       | 2 +-
 4 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/Configuration/PyReleaseValidation/README.md b/Configuration/PyReleaseValidation/README.md
index a8822e2bdbf34..d51a6fd4bf3eb 100644
--- a/Configuration/PyReleaseValidation/README.md
+++ b/Configuration/PyReleaseValidation/README.md
@@ -65,7 +65,7 @@ The offsets currently in use are:
 * 0.7561 HLT phase-2 timing menu Alpaka, trimmed tracking
 * 0.7562 HLT phase-2 timing menu Alpaka, trimmed tracking, single tracking iteration variant
 * 0.757: HLT phase-2 timing menu Alpaka, single tracking iteration, LST seeding + CKF building variant
-* 0.7571: HLT phase-2 timing menu Alpaka, single tracking iteration, LST seeding + mkFit building variant
+* 0.7571: HLT phase-2 timing menu Alpaka, single tracking iteration, Phase2CAExtension+LST seeding + mkFit building variant
 * 0.758 HLT phase-2 timing menu ticl_barrel variant
 * 0.759: HLT phase-2 timing menu, with NANO:@Phase2HLT
 * 0.76: HLT phase-2 reduced menu, with DIGI step
diff --git a/Configuration/PyReleaseValidation/python/relval_Run4.py b/Configuration/PyReleaseValidation/python/relval_Run4.py
index 208cb281cfb49..211237230b12b 100644
--- a/Configuration/PyReleaseValidation/python/relval_Run4.py
+++ b/Configuration/PyReleaseValidation/python/relval_Run4.py
@@ -81,7 +81,7 @@
 numWFIB.extend([prefixDet+34.7561])# HLTTiming75e33, alpaka,phase2_hlt_vertexTrimming
 numWFIB.extend([prefixDet+34.7562])# HLTTiming75e33, alpaka,phase2_hlt_vertexTrimming,singleIterPatatrack
 numWFIB.extend([prefixDet+34.757]) # HLTTiming75e33, alpaka,singleIterPatatrack,trackingLST,seedingLST
-numWFIB.extend([prefixDet+34.7571]) # HLTTiming75e33, alpaka,singleIterPatatrack,trackingLST,seedingLST,buildingMkFit
+numWFIB.extend([prefixDet+34.7571]) # HLTTiming75e33, alpaka,singleIterPatatrack,Phase2CAExtension,trackingLST,seedingLST,buildingMkFit
 numWFIB.extend([prefixDet+34.758]) # HLTTiming75e33, ticl_barrel
 numWFIB.extend([prefixDet+34.759]) # HLTTiming75e33 + NANO
 numWFIB.extend([prefixDet+34.77])  # NGTScouting
diff --git a/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py b/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py
index dd82480f25381..453ce039348b6 100644
--- a/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py
+++ b/Configuration/PyReleaseValidation/python/upgradeWorkflowComponents.py
@@ -2032,7 +2032,7 @@ def condition(self, fragment, stepList, key, hasHarvest):
 upgradeWFs['HLTTiming75e33AlpakaSingleIterLSTSeedingMkFitBuilding'].offset = 0.7571
 upgradeWFs['HLTTiming75e33AlpakaSingleIterLSTSeedingMkFitBuilding'].step2 = {
     '-s':'DIGI:pdigi_valid,L1TrackTrigger,L1,L1P2GT,DIGI2RAW,HLT:75e33_timing,VALIDATION:@hltValidation',
-    '--procModifiers': 'alpaka,singleIterPatatrack,trackingLST,seedingLST,trackingMkFitCommon,hltTrackingMkFitInitialStep',
+    '--procModifiers': 'alpaka,phase2CAExtension,singleIterPatatrack,trackingLST,seedingLST,trackingMkFitCommon,hltTrackingMkFitInitialStep',
     '--datatier':'GEN-SIM-DIGI-RAW,DQMIO',
     '--eventcontent':'FEVTDEBUGHLT,DQMIO'
 }
diff --git a/Configuration/PyReleaseValidation/scripts/runTheMatrix.py b/Configuration/PyReleaseValidation/scripts/runTheMatrix.py
index 6410fa5f9dcac..eb20103fcebb7 100755
--- a/Configuration/PyReleaseValidation/scripts/runTheMatrix.py
+++ b/Configuration/PyReleaseValidation/scripts/runTheMatrix.py
@@ -167,7 +167,7 @@ def runSelected(opt):
                     29634.7561,  # HLT phase-2 timing menu Alpaka, trimmed tracking
                     29634.7562,  # HLT phase-2 timing menu Alpaka, trimmed tracking, single tracking iteration variant
                     29634.757,   # HLT phase-2 timing menu Alpaka, single tracking iteration, LST seeding + CKF building variant
-                     29634.7571,  # HLT phase-2 timing menu Alpaka, single tracking iteration, LST seeding + mkFit building variant
+                     29634.7571,  # HLT phase-2 timing menu Alpaka, single tracking iteration, Phase2CAExtension+LST seeding + mkFit building variant
                     29634.758,   # HLT phase-2 timing menu ticl_barrel variant
                     29634.759,   # HLT phase-2 timing menu, with NANO:@Phase2HLT
                     29634.77,    # HLT phase-2 NGT Scouting menu
-- 
2.46.2
